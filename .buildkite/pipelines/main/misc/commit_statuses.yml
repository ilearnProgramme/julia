agents:
  queue: "julia"
  # Only run on `sandbox.jl` machines (not `docker`-isolated ones) since we need nestable sandboxing
  sandbox.jl: "true"
  os: "linux"
steps:
  - label: "analyze"
    key: "analyze"
    depends_on:
      - "analyzegc"
      # - "asan"
    plugins:
      - JuliaCI/julia#v1:
          version: 1.6
      - staticfloat/sandbox#v1:
          rootfs_url: https://github.com/JuliaCI/rootfs-images/releases/download/v3.1/package_linux.x86_64.tar.gz
          rootfs_treehash: "8c33c341a864852629b8aac01a6eb6a79b73570e"
          uid: 1000
          gid: 1000
          workspaces:
            # Include `/cache/repos` so that our `git` version introspection works.
            - "/cache/repos:/cache/repos"
    timeout_in_minutes: 10
    notify:
      - github_commit_status:
          context: "analyze"
    commands: |
      echo "All `analyze` jobs completed successfully."
  - label: "docs"
    key: "docs"
    depends_on:
      - "doctest"
      # - "docdeploy"
    plugins:
      - JuliaCI/julia#v1:
          version: 1.6
      - staticfloat/sandbox#v1:
          rootfs_url: https://github.com/JuliaCI/rootfs-images/releases/download/v3.1/package_linux.x86_64.tar.gz
          rootfs_treehash: "8c33c341a864852629b8aac01a6eb6a79b73570e"
          uid: 1000
          gid: 1000
          workspaces:
            # Include `/cache/repos` so that our `git` version introspection works.
            - "/cache/repos:/cache/repos"
    timeout_in_minutes: 10
    notify:
      - github_commit_status:
          context: "docs"
    commands: |
      echo "All `docs` jobs completed successfully."
  - label: "package"
    key: "package"
    depends_on:
      - "package_linux32"
      - "package_linux64"
    plugins:
      - JuliaCI/julia#v1:
          version: 1.6
      - staticfloat/sandbox#v1:
          rootfs_url: https://github.com/JuliaCI/rootfs-images/releases/download/v3.1/package_linux.x86_64.tar.gz
          rootfs_treehash: "8c33c341a864852629b8aac01a6eb6a79b73570e"
          uid: 1000
          gid: 1000
          workspaces:
            # Include `/cache/repos` so that our `git` version introspection works.
            - "/cache/repos:/cache/repos"
    timeout_in_minutes: 10
    notify:
      - github_commit_status:
          context: "package"
    commands: |
      echo "All `package` jobs completed successfully."
  - label: "test"
    key: "test"
    notify:
      - github_commit_status:
          context: "test"
    plugins:
      - JuliaCI/julia#v1:
          version: 1.6
      - staticfloat/sandbox#v1:
          rootfs_url: https://github.com/JuliaCI/rootfs-images/releases/download/v3.1/package_linux.x86_64.tar.gz
          rootfs_treehash: "8c33c341a864852629b8aac01a6eb6a79b73570e"
          uid: 1000
          gid: 1000
          workspaces:
            # Include `/cache/repos` so that our `git` version introspection works.
            - "/cache/repos:/cache/repos"
    timeout_in_minutes: 10
    allow_dependency_failure: true
    depends_on:
      - "embedding"
      - "llvmpasses"
      # - "tester_linux32"
      - "tester_linux32_st"
      - "tester_linux32_mt"
      - "tester_linux64_st"
      - "tester_linux64_mt"
      - "tester_linux64_st_rr"
      - "tester_linux64_mt_rr"
      # - "tester_linux64_rr"
    commands: |
      echo "embedding:            $(buildkite-agent step get "outcome" --step "embedding")"
      echo "llvmpasses:           $(buildkite-agent step get "outcome" --step "llvmpasses")"
      echo "tester_linux32:       $(buildkite-agent step get "outcome" --step "tester_linux32_st")"
      echo "tester_linux32:       $(buildkite-agent step get "outcome" --step "tester_linux32_mt")"
      echo "tester_linux64_st:    $(buildkite-agent step get "outcome" --step "tester_linux64_st")"
      echo "tester_linux64_mt:    $(buildkite-agent step get "outcome" --step "tester_linux64_mt")"
      echo "tester_linux64_st_rr: $(buildkite-agent step get "outcome" --step "tester_linux64_st_rr")"
      echo "tester_linux64_mt_rr: $(buildkite-agent step get "outcome" --step "tester_linux64_mt_rr")"
      [[ "$(buildkite-agent step get "outcome" --step "embedding")"            != "passed" ]] && exit 1
      [[ "$(buildkite-agent step get "outcome" --step "llvmpasses")"           != "passed" ]] && exit 1
      [[ "$(buildkite-agent step get "outcome" --step "tester_linux32")"       != "passed" ]] && exit 1
      [[ "$(buildkite-agent step get "outcome" --step "tester_linux64_st")"    != "passed" ]] && exit 1
      [[ "$(buildkite-agent step get "outcome" --step "tester_linux64_mt")"    != "passed" ]] && exit 1
      [[ "$(buildkite-agent step get "outcome" --step "tester_linux64_st_rr")" != "passed" ]] && exit 1
      [[ "$(buildkite-agent step get "outcome" --step "tester_linux64_mt_rr")" != "passed" ]] && exit 1
      exit 0
